"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationProducer = exports.NotificationTopic = exports.NotificationStatus = void 0;
const rxjs_1 = require("rxjs");
var NotificationStatus;
(function (NotificationStatus) {
    NotificationStatus["signing"] = "signing";
    NotificationStatus["success"] = "success";
    NotificationStatus["error"] = "error";
    NotificationStatus["pending"] = "pending";
})(NotificationStatus || (exports.NotificationStatus = NotificationStatus = {}));
var NotificationTopic;
(function (NotificationTopic) {
    NotificationTopic["tx"] = "tx";
    NotificationTopic["signature"] = "signature";
})(NotificationTopic || (exports.NotificationTopic = NotificationTopic = {}));
/**
 * MUST receive a success or error notification at some point to ensure the result promise resolves.
 */
class NotificationProducer {
    topic;
    _notifications$ = new rxjs_1.ReplaySubject(Number.POSITIVE_INFINITY);
    notifications$ = this._notifications$.asObservable();
    _result = (0, rxjs_1.lastValueFrom)(this._notifications$);
    consumer = {
        notifications$: this.notifications$,
        wait: this.wait.bind(this),
    };
    /**
     * Creates a notification producer.
     * MUST receive a success or error notification at some point to ensure the result promise resolves.
     * @param topic The notification topic to populate each notification with.
     */
    constructor(topic) {
        this.topic = topic;
    }
    async wait(observerOrNext) {
        const subscription = this.notifications$.subscribe(observerOrNext);
        const notification = (await this._result);
        subscription.unsubscribe();
        return notification;
    }
    next(notification) {
        this._notifications$.next({
            ...notification,
            topic: this.topic,
        });
        if (notification.status === NotificationStatus.success ||
            notification.status === NotificationStatus.error)
            this._notifications$.complete();
    }
}
exports.NotificationProducer = NotificationProducer;
