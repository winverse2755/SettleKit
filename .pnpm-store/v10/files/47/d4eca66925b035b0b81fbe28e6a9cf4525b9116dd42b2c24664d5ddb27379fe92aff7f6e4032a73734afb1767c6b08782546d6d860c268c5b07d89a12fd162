"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchVaultUser = fetchVaultUser;
exports.fetchVaultUserFromConfig = fetchVaultUserFromConfig;
const ethers_types_1 = require("ethers-types");
const blue_sdk_1 = require("@morpho-org/blue-sdk");
const VaultConfig_1 = require("./VaultConfig");
async function fetchVaultUser(vault, user, runner, options = {}) {
    options.chainId ??= Number((await runner.provider.getNetwork()).chainId);
    const config = await (0, VaultConfig_1.fetchVaultConfig)(vault, runner, options);
    return fetchVaultUserFromConfig(config, user, runner, options);
}
async function fetchVaultUserFromConfig(config, user, runner, options = {}) {
    options.chainId ??= Number((await runner.provider.getNetwork()).chainId);
    options.overrides ??= {};
    const mm = ethers_types_1.MetaMorpho__factory.connect(config.address, runner);
    const erc20 = ethers_types_1.ERC20__factory.connect(config.asset, runner);
    const [allowance, isAllocator] = await Promise.all([
        erc20.allowance(user, config.address, options.overrides),
        mm.isAllocator(user, options.overrides),
    ]);
    return new blue_sdk_1.VaultUser({
        vault: config.address,
        user,
        isAllocator,
        allowance,
    });
}
